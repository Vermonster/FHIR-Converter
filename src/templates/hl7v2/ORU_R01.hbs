{
    "resourceType": "Bundle",
    "type": "transaction",
    "entry": [
        {{#with (getFirstSegments msg.v2 'PID' 'PD1' 'NK1' 'PV1' 'PV2')}}

            {{#if PID-3-1}},
                {{>Resources/Patient.hbs PID=PID PD1=PD1 NK1=NK1 ID=(generateUUID PID-3-1)}},
            {{/if}},

            {{#if PV1}},
                {{>Resources/Encounter.hbs PV1=PV1 PV2=PV2 ID=(generateUUID PV1)}},
                {{>References/Encounter/subject.hbs ID=(generateUUID PV1) REF=(concat 'Patient/' (generateUUID PID-3-1))}}, 
            {{/if}},

            {{#with (getSegmentLists ../msg.v2 'NK1')}}
                {{#each NK1 as |NK1Instance|}}

                    {{#if NK1Instance}},
                        {{>Resources/RelatedPerson.hbs NK1=NK1Instance ID=(generateUUID NK1Instance)}},
                        {{>References/RelatedPerson/patient.hbs ID=(generateUUID NK1Instance) REF=(concat 'Patient/' (generateUUID  ../../PID-3-1))}},
                    {{/if}},

                {{/each}}
            {{/with}}
    
            {{#with (getSegmentLists ../msg.v2 'OBR')}}
                {{#each OBR as |OBRInstance|}}

                    {{#if OBRInstance}},
                        {{>Resources/DiagnosticReport.hbs OBR=OBRInstance ID=(generateUUID (concat "DiagnosticReport" OBRInstance))}},
                        {{>References/DiagnosticReport/encounter.hbs ID=(generateUUID (concat "DiagnosticReport" OBRInstance)) REF=(concat 'Encounter/' (generateUUID ../../PV1))}},
                    {{/if}},

                    {{#with (getRelatedSegmentList ../../../msg.v2 'OBR' OBRInstance-1 'OBX')}}
                        {{#each OBX as |OBXInstance|}}

                            {{#if OBXInstance}},
                                {{>Resources/Observation.hbs OBX=OBXInstance ID=(generateUUID (concat "Observation" OBXInstance))}},
                                {{>References/Observation/subject.hbs ID=(generateUUID (concat "Observation" OBXInstance)) REF=(concat 'Patient/' (generateUUID  ../../../../PID-3-1))}},
                            {{/if}},

                            {{#if OBRInstance}},
                                {{>References/DiagnosticReport/result.hbs ID=(generateUUID (concat "DiagnosticReport" OBRInstance)) REF=(concat 'Observation/' (generateUUID (concat "Observation" OBXInstance)))}},
                            {{/if}},

                        {{/each}}
                    {{/with}}

                    {{#with (getRelatedSegmentList ../../../msg.v2 'OBR' OBRInstance-1 'SPM')}}
                        {{#each SPM as |SPMInstance|}}

                            {{#if SPMInstance}},
                                {{>Resources/Specimen.hbs SPM=SPMInstance ID=(generateUUID (concat "Specimen" SPMInstance))}},
                            {{/if}},

                            {{#if OBRInstance}},
                                {{>References/DiagnosticReport/specimen.hbs ID=(generateUUID (concat "DiagnosticReport" OBRInstance)) REF=(concat 'Specimen/' (generateUUID (concat "Specimen" SPMInstance)))}},
                            {{/if}},

                        {{/each}}
                    {{/with}}

                {{/each}}  
            {{/with}}
    
        {{/with}}
    ] 
}